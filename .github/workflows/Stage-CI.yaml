name: Stage CI Pipeline

on:
  push:
    branches: [main]

jobs:

  Get_Latest_Version:
    needs: Build_and_Push
    uses: ./.github/workflows/get_latest_version.yaml
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

  Deploy:
    needs: Get_Latest_Version
    uses: ./.github/workflows/deploy.yaml
    with:
      filename: "manifests/default/svm.yaml"
      image_version: ${{ needs.Get_Latest_Version.outputs.latest_tag }}
    secrets:
      TOKEN: ${{ secrets.TOKEN }}
