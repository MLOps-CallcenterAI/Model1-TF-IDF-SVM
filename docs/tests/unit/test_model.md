# ðŸ§ª Test Suite: `test_model.py`

## ðŸ“˜ Overview

This module contains automated tests for validating the **MLflow-based SVM model** used in the CallCenterAI project.
It ensures that:

* Environment variables are correctly loaded.
* The model can be successfully retrieved from Databricks MLflow.
* Predictions are consistent and valid for multiple text inputs.

The tests use **Pytest fixtures** for reusable setup steps such as environment loading, model fetching, and sample data generation.

---

## ðŸ§© Fixtures

### `setup_env`

**Purpose:**
Loads Databricks credentials from the `.env` file and verifies that both `DATABRICKS_HOST` and `DATABRICKS_TOKEN` are present and valid.
If credentials are missing, the tests are **skipped**.

**Returns:**

```python
{"host": <str>, "token": <str>}
```

---

### `load_model`

**Purpose:**
Initializes the MLflow tracking URI, then loads the deployed **SVM text classification model** from the specified `model_uri`.

**Depends on:**
`setup_env`

**Returns:**
A scikit-learn model object with a `.predict()` method.

---

### `sample_data`

**Purpose:**
Provides a small, realistic dataset of text-based inputs for testing model inference.

**Returns:**
A pandas DataFrame with one column:

```python
{"text": ["cannot login to my account", ...]}
```

---

## ðŸ§  Tests

### âœ… `test_environment_loaded(setup_env)`

**Goal:**
Ensures that the `.env` file was correctly read and that the Databricks credentials are properly formatted.

**Assertions:**

* `DATABRICKS_HOST` must contain `"https://"`.
* `DATABRICKS_TOKEN` must start with `"dapi"` (standard Databricks token prefix).

---

### âœ… `test_model_loading(load_model)`

**Goal:**
Verifies that the model is successfully retrieved from MLflow.

**Assertions:**

* The loaded object is not `None`.
* The loaded object has a `.predict` method.

---

### âœ… `test_model_prediction(load_model, sample_data)`

**Goal:**
Checks the integrity and structure of predictions generated by the model.

**Assertions:**

* Predictions are iterable (list, tuple, Series, or ndarray).
* The number of predictions matches the number of inputs.
* Each prediction is either a string or integer label.

---

## ðŸ§° Technologies & Dependencies

* **pytest** â€” for testing and fixtures
* **mlflow** â€” for model loading from Databricks
* **pandas** â€” for structured input data
* **dotenv** â€” for managing environment variables

---

## ðŸ§¾ Notes

* The model URI is currently hardcoded as:

  ```
  models:/m-49e62ea546064bd1b56cff76a8aded2f
  ```

  To make it dynamic, you may load it from the `.env` file using:

  ```python
  model_uri = os.getenv("MODEL_URI")
  ```
* Ensure your `.env` contains valid:

  ```
  DATABRICKS_HOST=<your-host>
  DATABRICKS_TOKEN=<your-token>
  ```
---